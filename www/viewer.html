<html>
<head>

<style>
	#viewer {
		position:relative;
		width:400px;
		height:400px;
		/*height:600px;*/
		border:1px solid black;
		
		background:none;
		
		
	}
	
	#well, #surface {
		margin: 0;
		padding: 0;
		width: 100%;
		height: 100%;
		position: absolute;
		top: 0px;
		left: 0px;	
	}	
	
	#well {
		overflow-y:auto;
	}
		
	.tile {
		height:30px;
		border:1px solid red;
	}

</style>

  <script src="intersection-observer.js"></script>
  
  <script>
  
  var z1 = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
  var z2 = [0,1,'a', 'b', 2,3,4,'c',5,'d','e','f',6,7,'g','h',9,10,11,'i',12,'j',13,'k',14,'l', 15];
  
  var current_list = z1;
  
  //--------------------------------------------------------------------------------------
  // draw current 
  function draw(list) {
  
  	// stop looking at tiles
    var tiles = document.querySelectorAll('.tile');
	for (var tile of tiles) {
		if (window.IntersectionObserver) {
			this.io_info.unobserve(tile);
		}
	}  	
  
  	// clear tiles  
  	document.getElementById('well').innerHTML = "";
  	
  	var html = '';
  	for (var i in list) {
  		html += '<div class="tile" data-order="' + list[i] + '">' + list[i] + '</div>';
  	}
  	
  	document.getElementById('well').innerHTML = html;
  	
  	// observe new tiles
	console.log('load all the tiles');
	
	tiles = document.querySelectorAll('.tile');	

	// load all the tiles
	for (const tile of tiles) {
		if (window.IntersectionObserver) {
			this.io_info.observe(tile);
		}
	}  	
  }
  
  </script>


</head>
<body>

<button onclick="minus()">-</button>
<button onclick="plus()">+</button>

<div id="viewer">

	<div id="well">
	</div>
	
	<div id="mid" style="position:absolute;top:49%;height:2%;width:100%;border:1px solid red;"></div>

</div>

<div id="info"></div>


<script>

var visible = null;

// get location of row in middle of viewer

function minus() {
	current_list = z1;
	draw(current_list);
}

function plus() {
	current_list = z2;
	draw(current_list);
	/*
	const viewRect = viewer.getBoundingClientRect();
	const itemRect = visible.getBoundingClientRect();
	
	var vh = viewRect.height;
	 
	
	console.log("d=" + (itemRect.top - viewRect.top));


	// position w.r.t. viewer
	
	// which row is in the horizontal centre?
	
	// what are its exact coordinates?
	
	// if we zoom in, place correspodning node here (e.g., by scrolling)
	*/

}

var lastTimeout = null;

// Options to send information messages, for example the number of the page currently
// being displayed
var bar_info = {
  root: document.getElementById('viewer'),
  
  // only consider the viewport of the element displaying the pages
  rootMargin: '-45% 0px -45% 0px',

  // we want a big chunk of the page to be visible 
  // so we don't trigger events if just a bit appears                                     
  threshold: 1.0
};


if (window.IntersectionObserver) {

  // page information
  this.io_info = new IntersectionObserver(
    function callback(entries) {
    
      for (const entry of entries) {
        if (entry.isIntersecting) {
        let item = entry.target;
        //console.log("id=" + item.outerHTML);
        
        
          // remove previous timeout
          if (lastTimeout) clearTimeout(lastTimeout);

          lastTimeout = setTimeout(function() {

          if (item.hasAttribute('data-order')) {
          		// all we really need is to have the id of at least
          		// one element that is visible. Then when use does something we
          		// can compute where to put new drawing.
          		
          	var p =bar_info.root.getBoundingClientRect();
          	var c= item.getBoundingClientRect();
          
          	var text = "order=" + item.dataset.order + ' ' + (c.top - p.top) ;
	          console.log(text);
	          
	          /*
	          var parentPos = document.getElementById('parent-id').getBoundingClientRect(),
    childPos = document.getElementById('child-id').getBoundingClientRect(),
    */
	          
	          document.getElementById('info').innerHTML = text;
	          
	          visible = item;
	          
	          /*
	          // OK we have an row in the viewer, we want to get its coordinates
	          // w.r.t. to the viewer, use that to find the row that is in the
	          // centre of the viewer. We use that to place zoom in/out displays
	          
	          
	          // offset of item relative to well that holds the images
	          // which is item height * item order in list
	          console.log("offsetTop=" + item.offsetTop);
	          
	          
	          
	          
	          //console.log(item.offsetParent);
	          
	          var viewer = document.getElementById('viewer');
	          
	          // offset w.r.t. viewer div
			const viewRect = viewer.getBoundingClientRect();
			const itemRect = item.getBoundingClientRect();
			
			console.log("d=" + (itemRect.top - viewRect.top));
	          
	          
	          var viewer_h = viewer.clientHeight;
	          //console.log(viewer_h);
	          
	          //viewer.offsetHeight / item.offsetHeight
	          */
	          
	      } else {
	      	console.log("*");
	      }

          }, 100);
        
        
        /*
          let item = entry.target;
          
          // send listener (either this window, or its parent) a message 
          // when page being displayed changes
          
          // remove previous timeout
          if (lastMessageTimeout) clearTimeout(lastMessageTimeout);

          lastMessageTimeout = setTimeout(function() {

          if (item.hasAttribute('data-page')) {
	          listener.postMessage(item.dataset.page, "*");
	      } else {
	      	listener.postMessage(null, "*");
	      }

          }, 100);
          
          */
          
        }
      }	
    },
    bar_info
  );

}

draw(z1);

</script>



</body>
</html>
